/*
 * Tronix
 *
 * (c) 2014 Danijel Durakovic
 *
 */

Tronix=function(){Assets=function(){var e={gfx_sprites:"gfx/sprites.png",gfx_menu:"gfx/menu.png",gfx_ui:"gfx/ui.png",gfx_arrow:"gfx/arrow.png",graphs:"data/graphs.json",user:"data/user.json"};var t={};var n=function(e){return e.split(".").pop().toLowerCase()};var r=function(e,t){for(var n in e)if(e.hasOwnProperty(n))t(n,e[n])};return{Load:function(i,s){var o=0;var u=0;r(e,function(e,t){var r=n(t);if(["png","jpg","jpeg","json"].indexOf(r)>-1)u++});var a=function(){o++;if(s instanceof Function)s(o,u);if(i instanceof Function&&o==u)i()};r(e,function(e,r){var i=n(r);if(["png","jpg","jpeg"].indexOf(i)>-1){var s=t[e]=new Image;s.src=r;s.addEventListener("load",a,false)}else if("json"===i){var o=new XMLHttpRequest;o.open("get",r,true);o.send(null);o.onreadystatechange=function(){if(o.readyState===4&&o.status===200){var n=o.responseText;t[e]=JSON.parse(n);a()}}}})},Get:function(e){return t[e]}}}();var e=function(){var e;return{SetContext:function(t){e=t},SetAlpha:function(t){if(typeof t=="undefined")t=1;if(t>1)t=1;else if(t<0)t=0;e.globalAlpha=t},Clear:function(t,n,r,i){e.clearRect(t,n,r,i)},Text:function(t,n,r,i,s,o){if(typeof i=="undefined")i="#fff";if(typeof s=="undefined")s="left";if(typeof o=="undefined")o="12px sans-serif";e.textBaseline="top";e.fillStyle=i;e.textAlign=s;e.font=o;e.fillText(t,n,r)},Rect:function(t,n,r,i,s,o){if(typeof s=="undefined")s="#fff";if(typeof o=="undefined")o=1;e.strokeStyle=s;e.lineWidth=o;e.strokeRect(t,n,r,i)},RectFill:function(t,n,r,i,s){if(typeof s=="undefined")s="#fff";e.fillStyle=s;e.fillRect(t,n,r,i)},Line:function(t,n,r,i,s,o){if(typeof s=="undefined")s="#fff";if(typeof o=="undefined")o=1;e.strokeStyle=s;e.lineWidth=o;e.beginPath();e.moveTo(t,n);e.lineTo(r,i);e.stroke()},Image:function(t,n,r,i,s){if(typeof i!="undefined"&&typeof s!="undefined"){e.drawImage(t,n,r,i,s)}else{e.drawImage(t,n,r)}},Tile:function(t,n,r,i,s,o,u){e.drawImage(t,o,u,i,s,n,r,i,s)}}}();var t=function(){var e;var t=0;var n=1;var r=function(t,r){var i=Math.max(e.width/window.innerWidth,e.height/window.innerHeight);var s=e.getBoundingClientRect();var o=r===n?t.changedTouches[0].clientX:t.clientX;var u=r===n?t.changedTouches[0].clientY:t.clientY;return{x:Math.floor((o-s.left)*i),y:Math.floor((u-s.top)*i)}};var i=[];var s=[];var o=[];var u=function(e,n){if(e.preventDefault)e.preventDefault();if(n===t){var s=e.which||e.button;if(s!==1)return}var o=r(e,n);for(var u=0;u<i.length;u++)i[u](o);return false};var a=function(e,t){if(e.preventDefault)e.preventDefault();var n=r(e,t);for(var i=0;i<s.length;i++)s[i](n);return false};var f=function(e,n){if(e.preventDefault)e.preventDefault();if(n===t){var i=e.which||e.button;if(i!==1)return}var s=r(e,n);for(var u=0;u<o.length;u++)o[u](s);return false};return{Init:function(r){e=r;r.addEventListener("mousedown",function(e){u(e,t)},false);r.addEventListener("touchstart",function(e){u(e,n)},false);window.addEventListener("mousemove",function(e){a(e,t)},false);window.addEventListener("touchmove",function(e){a(e,n)},false);window.addEventListener("mouseup",function(e){f(e,t)},false);window.addEventListener("touchend",function(e){f(e,n)},false)},Register:function(e,t){if(e==="press")i.push(t);else if(e==="move")s.push(t);else if(e==="release")o.push(t)}}}();var n=function(){var n;var r,i,s,o;var u;var a;var f={unlocked:0};var l=function(){localStorage.setItem("tronix",JSON.stringify(f))};var c=function(){var e=localStorage.getItem("tronix");if(e)f=JSON.parse(e)};var h=function(e,t,n,r,i,s){return e>=n&&e<=n+i&&t>=r&&t<=r+s};var p=function(){var n=false;var r=true;var o=false;var a=0;var l=function(e,t){if(typeof t=="undefined"){t=0}a=e?114-t:t;if(t<114)setTimeout(function(){l(e,t+3)},1);else{r=e;n=false;o=!e}};var c=0;var p=function(){return 114-a};var d=function(n){function f(e){if(typeof e=="undefined")e=0;n.OnPush();a=setTimeout(function(){f(Math.min(e+1,20))},e===0?400:120-e*4)}var r=false;var i=false;var u=function(e){return h(e.x,e.y,n.x,n.y,72,72)};var a=null;t.Register("press",function(e){if(!o)return;if(u(e)){i=true;r=true;if(n.pushBehavior){f()}}});t.Register("move",function(e){if(!o)return;if(r){i=u(e);if(!i){clearTimeout(a);a=null}else if(!a&&n.pushBehavior){f()}}});t.Register("release",function(e){if(!o)return;if(r){if(i){if(!n.pushBehavior)n.OnPush();else{clearTimeout(a);a=null}}r=false;i=false}});this.DoDrawing=function(){e.Tile(s,n.x,n.y+p(),72,72,i?72:0,5);e.Tile(s,n.x+11,n.y+11+p(),50,50,n.icon[0],n.icon[1])}};var v=new d({x:5,y:374,icon:[150,5],pushBehavior:false,OnPush:function(){if(c<=f.unlocked){A(c);n=true;l(true);o=false}}});var g=new d({x:166,y:374,icon:[200,5],pushBehavior:true,OnPush:function(){if(c>0)c--}});var y=new d({x:243,y:374,icon:[250,5],pushBehavior:true,OnPush:function(){if(c<u.length-1){c++}}});t.Register("press",function(e){if(r){if(!n&&h(e.x,e.y,0,456,320,24)){n=true;l(false);c=m.GetIndex()}}else{if(!n&&h(e.x,e.y,0,0,320,366)){n=true;l(true);o=false}}});var b=function(){var t=[96,374,54,80];var n=function(e){return[t[0]+Math.floor(e[0]*t[2]/320),t[1]+Math.floor(e[1]*t[3]/480)]};var r=u[c];if(typeof r=="undefined")return;var i=r.V;var o=r.E;if(typeof o=="undefined"||typeof i=="undefined")return;for(var a=0;a<o.length;a++){var f=o[a];var l=i[f[0]];var h=i[f[1]];var d=n(l);var v=n(h);e.Line(d[0],d[1]+p(),v[0],v[1]+p(),"#2ad",1)}for(var a=0;a<i.length;a++){var m=i[a];var g=n(m);e.Tile(s,g[0]-3,g[1]-3+p(),6,6,150,55)}};return{IsFolded:function(){return r},DoDrawing:function(){e.Tile(i,0,456-a,320,24+a,0,0);if(a>0){var t=c+1+" / "+u.length;var n=320*(c+1)/u.length;e.Tile(s,0,451+p(),n,5,0,0);e.Text(t,160,460+p(),"#ccc","center");v.DoDrawing();g.DoDrawing();y.DoDrawing();if(c<=f.unlocked)b();else e.Tile(s,96,374+124-a,50,50,200,55)}}}}();var d=function(){var t=null;var n=1;var r=0;var i=function(e){if(typeof e=="undefined")e=0;r=20-e;n=e/20;if(e<20)setTimeout(function(){i(e+1)},16)};return{ShowTutorial:function(e){var n=a.tutorials;if(typeof n=="undefined")return;var s=n[e];if(typeof s=="undefined"){t=null;return}t=s;r=20;i()},DoDrawing:function(){if(t!=null){for(var i=0;i<t.text.length;i++){if(n<1)e.SetAlpha(n);e.Text(t.text[i],1+t.x,1+t.y+18*i+r,"#222");e.Text(t.text[i],t.x,t.y+18*i+r,"#bb9");if(n<1)e.SetAlpha()}}}}}();var v=function(){var n=false;var r=false;var i=1;var s=0;var u=0;setInterval(function(){u++;if(u>10)u=0},80);var a=function(e){if(typeof e=="undefined")e=0;s=20-e;i=e/20;if(e<20)setTimeout(function(){a(e+1)},16);else r=true};t.Register("press",function(e){if(!r||!p.IsFolded())return;if(h(e.x,e.y,260,390,40,40)){A(m.NextIndex())}});return{Show:function(){if(n)return;n=true;a()},Hide:function(){n=false;r=false},DoDrawing:function(){if(n){if(i<1)e.SetAlpha(i);e.Tile(o,260,390+s,40,40,u*40,0);if(i<1)e.SetAlpha()}}}}();var m=function(){var e=[];var t=[];var n=0;return{Load:function(r){n=r;var i=u[r];if(typeof i=="undefined")return;e=[];t=[];for(var s=0;s<i.V.length;s++)e.push(i.V[s].slice());for(var s=0;s<i.E.length;s++)t.push(i.E[s].slice())},GetV:function(){return e},GetE:function(){return t},GetIndex:function(){return n},NextIndex:function(){return n+1}}}();var g=-1;var y=0;var b=0;var w=0;var E=function(e){if(typeof e=="undefined")e=0;w=e/20;if(e<20)setTimeout(function(){E(e+1)},10)};var S=false;var x=-1;var T=function(e,t,n,r){var i=function(e,t,n){return(n[1]-e[1])*(t[0]-e[0])>(t[1]-e[1])*(n[0]-e[0])};return i(e,n,r)!=i(t,n,r)&&i(e,t,n)!=i(e,t,r)};var N=function(e,t,n){var r=[t[0]-e[0],t[1]-e[1]];var i=Math.pow(r[0],2)+Math.pow(r[1],2);if(i==0)return 0;var s=Math.min(1,Math.max(0,(r[0]*(n[0]-e[0])+r[1]*(n[1]-e[1]))/i));var o=e[0]+s*r[0];var u=e[1]+s*r[1];return Math.sqrt(Math.pow(n[0]-o,2)+Math.pow(n[1]-u,2))};var C=function(e,t,n){var r=Math.atan2(t[1]-e[1],t[0]-e[0])*180/Math.PI;e[0]+=Math.floor(Math.cos(r*Math.PI/180)*n);e[1]+=Math.floor(Math.sin(r*Math.PI/180)*n)};var k=function(e,t,n){C(e,t,n);C(t,e,n)};var L=function(){var e=m.GetV();var t=m.GetE();for(var n=0;n<t.length-1;n++){for(var r=n+1;r<t.length;r++){var i=t[n];var s=t[r];var o=i[0];var u=i[1];var a=s[0];var f=s[1];var l=[e[o][0],e[o][1]];var c=[e[u][0],e[u][1]];var h=[e[a][0],e[a][1]];var p=[e[f][0],e[f][1]];k(l,c,12);k(h,p,12);if(T(l,c,h,p))return true}}for(var n=0;n<e.length;n++){var d=e[n];for(var r=0;r<t.length;r++){var v=t[r];if(v[0]==n||v[1]==n)continue;var l=[e[v[0]][0],e[v[0]][1]];var c=[e[v[1]][0],e[v[1]][1]];var g=[d[0],d[1]];if(N(l,c,g)<12)return true}}return false};t.Register("press",function(e){if(!p.IsFolded())return;if(g>-1)return;var t=m.GetV();for(var n=t.length-1;n>=0;n--){var r=t[n];if(h(e.x,e.y,r[0]-16,r[1]-16,32,32)){y=e.x-r[0];b=e.y-r[1];g=n;E();break}}});t.Register("move",function(e){if(g>-1){var t=m.GetV();var n=t[g];var r=e.x-y;var i=e.y-b;if(r>=12&&r<=308)n[0]=r;if(i>=12&&i<=438)n[1]=i}});t.Register("release",function(e){if(g>-1){g=-1;w=0;S=L();if([0,2].indexOf(x)>-1&&!S){x=1;d.ShowTutorial("won")}else if(x==1&&S){x=2;d.ShowTutorial("won2")}else if(x==3&&!S){x=4;d.ShowTutorial("goodluck")}if(!S&&m.GetIndex()<u.length-1){if(x==1||x==4){setTimeout(function(){v.Show()},200)}else v.Show()}}});var A=function(e){if(e>=0&&e<u.length){m.Load(e);S=L();if(e==0){d.ShowTutorial("first");x=0}else{if([1,2].indexOf(x)>-1){x=3;d.ShowTutorial("second")}else{x=-1;d.ShowTutorial()}}g=-1;v.Hide();if(f.unlocked<e){f.unlocked=e;l()}}};return{Init:function(e){r=Assets.Get("gfx_sprites");i=Assets.Get("gfx_menu");s=Assets.Get("gfx_ui");o=Assets.Get("gfx_arrow");u=Assets.Get("graphs");a=Assets.Get("user");c();var t=0;if(typeof a.forcelevel=="number")t=a.forcelevel;else if(typeof f.unlocked!="undefined"&&f.unlocked>=1&&f.unlocked<u.length)t=f.unlocked;A(t)},DoDrawing:function(){var t=m.GetV();var n=m.GetE();d.DoDrawing();e.SetAlpha(.7);for(var i=0;i<n.length;i++){var s=n[i];var o;if(s[0]===g||s[1]===g)o=a.color_highlight||"#cc2";else if(S)o=a.color_unsolved||"#2ad";else o=a.color_solved||"#7fdb1d";var u=t[s[0]];var f=t[s[1]];e.Line(u[0],u[1],f[0],f[1],o,a.thickness||6)}e.SetAlpha();var l=S?24:0;for(var i=0;i<t.length;i++){var c=t[i];e.Tile(r,c[0]-12,c[1]-12,24,24,l,0);if(a.touch_indicator!=="no"&&g===i){if(w<1)e.SetAlpha(w);e.Tile(r,c[0]-21,c[1]-21,42,42,0,24);if(w<1)e.SetAlpha()}if(a.debug==="yes")e.Text(i,c[0]+12,c[1]-20)}v.DoDrawing();p.DoDrawing()},UnlockAll:function(){f.unlocked=u.length-1;l()},ForgetAll:function(){f.unlocked=0;l();A(f.unlocked)}}}();var r=function(){var r,i;var s;var o=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};var u=function(){var t=r.width;var i=r.height;var a=window.innerHeight;if(a!==s){s=a;var f=t/i;var l=a*f;r.style.width=l+"px";r.style.height=a+"px"}e.RectFill(0,0,t,i,"#191916");n.DoDrawing();o(u)};return{Start:function(){r=document.getElementById("tronix");var s=document.getElementById("tronix-loadscreen");var o=document.getElementById("tronix-progressbar");var a=document.getElementById("tronix-progresslabel");e.SetContext(i=r.getContext("2d"));t.Init(r);Assets.Load(function(){s.style.display="none";r.style.display="block";n.Init(r);u()},function(e,t){var n=Math.floor(e*100/t)+"%";a.innerHTML=o.style.width=n})}}}();window.addEventListener("load",r.Start,false);return{UnlockAll:function(){n.UnlockAll()},ForgetAll:function(){n.ForgetAll()}}}()
